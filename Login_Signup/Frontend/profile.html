<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BookNest - Profile (Dark Admin Theme)</title>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --brand: #c5864a;      /* Admin Gold */
      --bg: #111;
      --card: #1a1a1a;
      --border: #2a2a2a;
      --text: #f1f1f1;
      --muted: #888;
      --danger: #dc3545;
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      color: var(--text);
      min-height: 100vh;
    }

    /* Full-screen background */
    /* .background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('background.jpg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      z-index: 0;
    } */
     .background {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: url('background.jpg');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  z-index: -1; /* <- change this */
}

    /* NAVBAR */
    .navbar {
      background: var(--card);
      padding: 18px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }

    .navbar-brand {
      color: var(--brand);
      font-size: 26px;
      font-weight: 700;
      display: flex;
      align-items:center;
      gap:8px;
    }

    .nav-btn {
      border: 1px solid #444;
      background: transparent;
      color: var(--text);
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: .3s;
      margin-left: 10px;
    }

    .nav-btn:hover {
      color: var(--brand);
      border-color: var(--brand);
    }

    .home-btn {
      background: var(--brand);
      color:#111;
      border-color: var(--brand);
    }

    .container {
      max-width:900px;
      margin:40px auto;
      padding:0 20px;
    }

    /* PROFILE HEADER */
    .profile-header {
      background: var(--card);
      padding:40px;
      border-radius:18px;
      border:1px solid var(--border);
      text-align:center;
      margin-bottom:25px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.4);
    }

    .profile-avatar {
      width:110px;
      height:110px;
      background:var(--brand);
      color:#111;
      display:flex;
      justify-content:center;
      align-items:center;
      border-radius:50%;
      font-size:50px;
      margin:0 auto 20px;
    }

    /* SECTION CARDS */
    .profile-section {
      background: var(--card);
      border-radius:18px;
      padding:25px 30px;
      margin-bottom:25px;
      border:1px solid var(--border);
      box-shadow: 0px 2px 20px rgba(0,0,0,0.35);
    }

    .section-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding-bottom:12px;
      border-bottom:1px solid var(--border);
      margin-bottom:15px;
    }

    .section-header h2 {
      font-size:20px;
      display:flex;
      align-items:center;
      gap:10px;
      color: var(--text);
    }

    .edit-btn {
      border:1px solid var(--brand);
      color:var(--brand);
      background:transparent;
      padding:6px 12px;
      border-radius:6px;
      cursor:pointer;
      transition:.3s;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .edit-btn:hover {
      background: var(--brand);
      color:#111;
    }

    /* VIEW/EDIT MODE SYSTEM */
    .view-mode, .edit-mode { display:none; }
    .view-mode.active, .edit-mode.active { display:block; }

    /* INFO ROWS */
    .info-row {
      display:flex;
      justify-content:space-between;
      padding:12px 0;
      border-bottom:1px solid var(--border);
      font-size:15px;
    }

    .info-label { color: var(--muted); }

    /* INPUT FIELDS (Dark Mode) */
    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: var(--muted);
    }

    .form-group input {
      width:100%;
      padding:12px;
      background:#111;
      border:1px solid #444;
      color:var(--text);
      border-radius:8px;
      font-size:15px;
    }

    .form-group input:focus {
      border-color: var(--brand);
      outline:none;
    }

    /* BUTTONS */
    .btn-primary {
      background: var(--brand);
      padding:12px 22px;
      border:none;
      border-radius:8px;
      color:#111;
      font-weight:600;
      cursor:pointer;
      margin-right: 10px;
    }

    .btn-secondary {
      background:#444;
      padding:12px 22px;
      border:none;
      border-radius:8px;
      color:#ddd;
      cursor:pointer;
      margin-right: 10px;
    }

    .btn-primary:hover, .btn-secondary:hover { opacity:.85; }

    .btn-danger {
      background: var(--danger);
      padding:12px 22px;
      border:none;
      border-radius:8px;
      color:white;
      cursor:pointer;
      font-weight:600;
    }

    /* DANGER ZONE */
    .danger-zone {
      border:1px solid var(--danger);
      padding:20px;
      background:#181818;
      border-radius:12px;
    }

    /* MESSAGE STYLES */
    .message {
      padding: 10px;
      margin: 10px 0;
      border-radius: 6px;
      display: none;
    }

    .message.success {
      background: #155724;
      color: #d4edda;
      border: 1px solid #c3e6cb;
      display: block;
    }

    .message.error {
      background: #721c24;
      color: #f8d7da;
      border: 1px solid #f5c6cb;
      display: block;
    }

    /* MODAL */
    .modal {
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.65);
      display:none;
      justify-content:center;
      align-items:center;
      z-index: 1000;
    }

    .modal.show { display:flex; }

    .modal-content {
      background:white;
      padding:30px;
      border-radius:16px;
      width:90%;
      max-width:450px;
      color:black;
      text-align:center;
    }

    .modal-buttons {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }
  </style>
</head>

<body>
  <div class="background"></div>

  <!-- NAVBAR -->
  <nav class="navbar">
    <div class="navbar-brand"><i class="fas fa-book"></i> BookNest</div>

    <div class="navbar-menu">
      <button class="nav-btn home-btn" onclick="goToHome()">Home</button>
      <button class="nav-btn" onclick="handleLogout()">Logout</button>
    </div>
  </nav>

  <div class="container">

    <!-- PROFILE HEADER -->
    <div class="profile-header">
      <div class="profile-avatar"><i class="fas fa-user"></i></div>
      <h2 id="profileName">Dev User</h2>
      <p id="profileEmail" style="color:#ccc;">dev@example.com</p>
    </div>

    <!-- PERSONAL INFO -->
    <div class="profile-section">

      <div class="section-header">
        <h2><i class="fas fa-user"></i> Personal Information</h2>
        <button class="edit-btn" onclick="toggleEditMode('name')">
          <i class="fas fa-edit"></i> Edit
        </button>
      </div>

      <!-- VIEW MODE -->
      <div id="nameViewMode" class="view-mode active">
        <div class="info-row">
          <span class="info-label">Name</span>
          <span id="displayName" class="info-value">Dev User</span>
        </div>

        <div class="info-row">
          <span class="info-label">Email</span>
          <span id="displayEmail" class="info-value">dev@example.com</span>
        </div>

        <div class="info-row">
          <span class="info-label">Role</span>
          <span id="displayRole" class="info-value">Admin</span>
        </div>

        <div class="info-row">
          <span class="info-label">Member Since</span>
          <span id="displayMemberSince" class="info-value">November 16, 2025</span>
        </div>
      </div>

      <!-- EDIT MODE -->
      <div id="nameEditMode" class="edit-mode">
        <form id="updateNameForm">
          <div class="form-group">
            <label>New Name</label>
            <input id="newName" placeholder="Enter new name">
          </div>

          <div id="nameMessage" class="message"></div>

          <div style="margin-top:15px;">
            <button type="submit" class="btn-primary">Save Changes</button>
            <button type="button" class="btn-secondary" onclick="cancelEdit('name')">Cancel</button>
          </div>
        </form>
      </div>

    </div>

    <!-- SECURITY -->
    <div class="profile-section">

      <div class="section-header">
        <h2><i class="fas fa-lock"></i> Security</h2>
        <button class="edit-btn" onclick="toggleEditMode('password')">
          <i class="fas fa-key"></i> Change Password
        </button>
      </div>

      <!-- VIEW -->
      <div id="passwordViewMode" class="view-mode active">
        <div class="info-row">
          <span class="info-label">Password</span>
          <span class="info-value">••••••••</span>
        </div>
        <div class="info-row">
          <span class="info-label">Last Updated</span>
          <span id="passwordLastUpdated" class="info-value">November 16, 2025</span>
        </div>
      </div>

      <!-- EDIT -->
      <div id="passwordEditMode" class="edit-mode">
        <form id="updatePasswordForm">
          <button type="button" id="sendPasswordOtpBtn" class="btn-primary" style="margin-bottom:12px; width: 100%;" onclick="sendPasswordChangeOTP()">Send OTP to Email</button>
          
          <div id="passwordOtpSentMsg" style="display: none; color: var(--brand); margin-bottom: 15px;">
            <i class="fas fa-check-circle"></i> OTP sent to your email!
          </div>

          <div id="passwordOtpSection" style="display: none;">
            <div class="form-group">
              <label>OTP</label>
              <input id="passwordOtp" placeholder="Enter OTP">
            </div>

            <div class="form-group">
              <label>Current Password</label>
              <input type="password" id="currentPassword" placeholder="Enter current password">
            </div>

            <div class="form-group">
              <label>New Password</label>
              <input type="password" id="newPassword" placeholder="Enter new password">
              <ul style="margin:8px 0 0 15px; font-size:13px; color:#bbb;">
                <li>At least 8 characters</li>
                <li>One uppercase letter</li>
                <li>One lowercase letter</li>
                <li>One number</li>
                <li>One special character</li>
              </ul>
            </div>

            <div class="form-group">
              <label>Confirm New Password</label>
              <input type="password" id="confirmPassword" placeholder="Confirm new password">
            </div>
          </div>

          <div id="passwordMessage" class="message"></div>

          <div style="margin-top:15px;">
            <button type="submit" class="btn-primary">Update Password</button>
            <button type="button" class="btn-secondary" onclick="cancelEdit('password')">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- DANGER ZONE -->
    <div class="profile-section">
      <div class="section-header">
        <h2>
          <i class="fas fa-exclamation-triangle" style="color:var(--danger)"></i>
          Danger Zone
        </h2>
      </div>

      <div class="danger-zone">
        <h3 style="color:var(--danger)">Delete Account</h3>
        <p style="color:#bbb;font-size:14px;">This cannot be undone. Please be certain.</p>
        <button class="btn-danger" onclick="showDeleteModal()">Delete My Account</button>
      </div>
    </div>

  </div>

  <!-- DELETE ACCOUNT MODAL -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <h3 style="color: var(--danger); margin-bottom: 15px;">Delete Account</h3>
      <p>Are you sure you want to delete your account? This action cannot be undone.</p>
      
      <button type="button" id="sendDeleteOtpBtn" class="btn-primary" style="margin: 15px 0; width: 100%;" onclick="sendAccountDeletionOTP()">Send OTP to Confirm</button>
      
      <div id="deleteOtpSentMsg" style="display: none; color: #28a745; margin-bottom: 15px;">
        <i class="fas fa-check-circle"></i> OTP sent to your email!
      </div>

      <div id="deleteOtpSection" style="display: none;">
        <div class="form-group">
          <label>Enter OTP</label>
          <input id="deleteOtp" placeholder="Enter OTP received via email">
        </div>
      </div>

      <div id="deleteModalMessage" class="message"></div>

      <div class="modal-buttons">
        <button type="button" class="btn-danger" onclick="confirmDelete()">Delete Account</button>
        <button type="button" class="btn-secondary" onclick="closeDeleteModal()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:3000/api/auth';
    let currentUser = null;
    let passwordChangeOtpSent = false;
    let accountDeletionOtpSent = false;

    window.addEventListener('DOMContentLoaded', async function() {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Please login first');
        window.location.href = 'index.html';
        return;
      }
      await loadProfile();
      
      // Add event listeners to navbar buttons
      document.querySelector('.home-btn').addEventListener('click', goToHome);
      document.querySelector('.nav-btn:not(.home-btn)').addEventListener('click', handleLogout);
    });

    async function loadProfile() {
      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE_URL}/profile`, {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        if (response.ok && result.success) {
          currentUser = result.user;
          displayProfile(result.user);
        } else {
          throw new Error(result.message || 'Failed to load profile');
        }
      } catch (error) {
        console.error('Error loading profile:', error);
        alert('Failed to load profile. Please login again.');
        localStorage.clear();
        window.location.href = 'index.html';
      }
    }

    function displayProfile(user) {
      document.getElementById('profileName').textContent = user.name || 'User';
      document.getElementById('profileEmail').textContent = user.email || 'No email';
      document.getElementById('displayName').textContent = user.name || 'User';
      document.getElementById('displayEmail').textContent = user.email || 'No email';
      
      const role = user.role || 'user';
      document.getElementById('displayRole').textContent = role.charAt(0).toUpperCase() + role.slice(1);

      if (user.createdAt) {
        const date = new Date(user.createdAt);
        document.getElementById('displayMemberSince').textContent = date.toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
      } else {
        document.getElementById('displayMemberSince').textContent = 'Unknown';
      }

      if (user.updatedAt) {
        const date = new Date(user.updatedAt);
        document.getElementById('passwordLastUpdated').textContent = date.toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
      } else {
        document.getElementById('passwordLastUpdated').textContent = 'Unknown';
      }

      if (document.getElementById('newName')) {
        document.getElementById('newName').value = user.name || '';
      }
    }

    function toggleEditMode(section) {
      document.getElementById(`${section}ViewMode`).classList.remove('active');
      document.getElementById(`${section}EditMode`).classList.add('active');
      
      // Reset OTP states when opening edit modes
      if (section === 'password') {
        passwordChangeOtpSent = false;
        document.getElementById('passwordOtpSection').style.display = 'none';
        document.getElementById('sendPasswordOtpBtn').style.display = 'block';
        document.getElementById('passwordOtpSentMsg').style.display = 'none';
        document.getElementById('passwordMessage').textContent = '';
        document.getElementById('passwordMessage').className = 'message';
      }
    }

    function cancelEdit(section) {
      document.getElementById(`${section}ViewMode`).classList.add('active');
      document.getElementById(`${section}EditMode`).classList.remove('active');
      hideMessage(`${section}Message`);

      if (section === 'name') {
        document.getElementById('updateNameForm').reset();
        if (currentUser) {
          document.getElementById('newName').value = currentUser.name || '';
        }
      } else if (section === 'password') {
        document.getElementById('updatePasswordForm').reset();
        passwordChangeOtpSent = false;
        document.getElementById('passwordOtpSection').style.display = 'none';
        document.getElementById('sendPasswordOtpBtn').style.display = 'block';
        document.getElementById('passwordOtpSentMsg').style.display = 'none';
      }
    }

    document.getElementById('updateNameForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const newName = document.getElementById('newName').value.trim();
      if (!newName) {
        showMessage('nameMessage', 'Name cannot be empty', 'error');
        return;
      }

      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE_URL}/profile/name`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ name: newName })
        });

        const result = await response.json();
        if (response.ok && result.success) {
          showMessage('nameMessage', 'Name updated successfully!', 'success');
          await loadProfile();
          setTimeout(() => cancelEdit('name'), 2000);
        } else {
          showMessage('nameMessage', result.message || 'Failed to update name', 'error');
        }
      } catch (error) {
        console.error('Error updating name:', error);
        showMessage('nameMessage', 'An error occurred. Please try again.', 'error');
      }
    });

    async function sendPasswordChangeOTP() {
      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE_URL}/send-password-change-otp`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });

        const result = await response.json();
        if (response.ok && result.success) {
          passwordChangeOtpSent = true;
          document.getElementById('passwordOtpSection').style.display = 'block';
          document.getElementById('sendPasswordOtpBtn').style.display = 'none';
          document.getElementById('passwordOtpSentMsg').style.display = 'block';
          showMessage('passwordMessage', 'OTP sent to your email!', 'success');
        } else {
          showMessage('passwordMessage', result.message || 'Failed to send OTP', 'error');
        }
      } catch (error) {
        console.error('Error sending password change OTP:', error);
        showMessage('passwordMessage', 'Failed to send OTP. Please try again.', 'error');
      }
    }

    document.getElementById('updatePasswordForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!passwordChangeOtpSent) {
        showMessage('passwordMessage', 'Please request OTP first', 'error');
        return;
      }

      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const otp = document.getElementById('passwordOtp').value.trim();

      if (!otp) {
        showMessage('passwordMessage', 'OTP is required', 'error');
        return;
      }

      if (newPassword !== confirmPassword) {
        showMessage('passwordMessage', 'Passwords do not match', 'error');
        return;
      }

      if (!validatePassword(newPassword)) {
        showMessage('passwordMessage', 'Password must meet all requirements', 'error');
        return;
      }

      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE_URL}/profile/password`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ 
            currentPassword, 
            newPassword, 
            otp 
          })
        });

        const result = await response.json();
        if (response.ok && result.success) {
          showMessage('passwordMessage', 'Password updated successfully!', 'success');
          document.getElementById('updatePasswordForm').reset();
          passwordChangeOtpSent = false;
          document.getElementById('passwordOtpSection').style.display = 'none';
          document.getElementById('sendPasswordOtpBtn').style.display = 'block';
          document.getElementById('passwordOtpSentMsg').style.display = 'none';
          await loadProfile(); // Refresh profile to get updated timestamp
          setTimeout(() => cancelEdit('password'), 2000);
        } else {
          showMessage('passwordMessage', result.message || 'Failed to update password', 'error');
        }
      } catch (error) {
        console.error('Error updating password:', error);
        showMessage('passwordMessage', 'An error occurred. Please try again.', 'error');
      }
    });

    function validatePassword(password) {
      return password.length >= 8 &&
             /[A-Z]/.test(password) &&
             /[a-z]/.test(password) &&
             /\d/.test(password) &&
             /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
    }

    function showMessage(elementId, message, type) {
      const msgElement = document.getElementById(elementId);
      msgElement.textContent = message;
      msgElement.className = `message ${type}`;
    }

    function hideMessage(elementId) {
      const msgElement = document.getElementById(elementId);
      msgElement.textContent = '';
      msgElement.className = 'message';
    }

    function showDeleteModal() {
      accountDeletionOtpSent = false;
      document.getElementById('deleteOtpSection').style.display = 'none';
      document.getElementById('sendDeleteOtpBtn').style.display = 'block';
      document.getElementById('deleteOtpSentMsg').style.display = 'none';
      document.getElementById('deleteModalMessage').textContent = '';
      document.getElementById('deleteModalMessage').className = 'message';
      document.getElementById('deleteModal').classList.add('show');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('show');
    }

    async function sendAccountDeletionOTP() {
      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE_URL}/send-account-deletion-otp`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });

        const result = await response.json();
        if (response.ok && result.success) {
          accountDeletionOtpSent = true;
          document.getElementById('deleteOtpSection').style.display = 'block';
          document.getElementById('sendDeleteOtpBtn').style.display = 'none';
          document.getElementById('deleteOtpSentMsg').style.display = 'block';
          document.getElementById('deleteModalMessage').textContent = 'OTP sent to your email!';
          document.getElementById('deleteModalMessage').className = 'message success';
        } else {
          document.getElementById('deleteModalMessage').textContent = result.message || 'Failed to send OTP';
          document.getElementById('deleteModalMessage').className = 'message error';
        }
      } catch (error) {
        console.error('Error sending account deletion OTP:', error);
        document.getElementById('deleteModalMessage').textContent = 'Failed to send OTP. Please try again.';
        document.getElementById('deleteModalMessage').className = 'message error';
      }
    }

    async function confirmDelete() {
      if (!accountDeletionOtpSent) {
        document.getElementById('deleteModalMessage').textContent = 'Please request OTP first';
        document.getElementById('deleteModalMessage').className = 'message error';
        return;
      }

      const otp = document.getElementById('deleteOtp').value.trim();
      if (!otp) {
        document.getElementById('deleteModalMessage').textContent = 'Please enter OTP';
        document.getElementById('deleteModalMessage').className = 'message error';
        return;
      }

      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`${API_BASE_URL}/profile`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ otp })
        });

        const result = await response.json();
        if (response.ok && result.success) {
          localStorage.clear();
          alert('Your account has been deleted successfully.');
          window.location.href = 'index.html';
        } else {
          document.getElementById('deleteModalMessage').textContent = result.message || 'Failed to delete account';
          document.getElementById('deleteModalMessage').className = 'message error';
        }
      } catch (error) {
        console.error('Error deleting account:', error);
        document.getElementById('deleteModalMessage').textContent = 'An error occurred. Please try again.';
        document.getElementById('deleteModalMessage').className = 'message error';
      }
    }

    function goToHome() {
      window.location.href = 'home.html';
    }

    async function handleLogout() {
      if (confirm('Are you sure you want to logout?')) {
        const token = localStorage.getItem('token');
        try {
          await fetch(`${API_BASE_URL}/logout`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
          });
        } catch (error) {
          console.error('Logout error:', error);
        }
        localStorage.clear();
        alert('Logged out successfully!');
        window.location.href = 'index.html';
      }
    }
  </script>
</body>
</html>